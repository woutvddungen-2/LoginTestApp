@page "/cookiedebug"
@inject HttpClient Http

<h3>Cookie Debug Tool</h3>

<p>
    <button class="btn btn-primary" @onclick="LoginAndCheckCookie">Login & Check Cookie</button>
</p>

@if (!string.IsNullOrEmpty(Status))
{
    <p><strong>Status:</strong> @Status</p>
}

@code {
    private string Status = "";

    private async Task LoginAndCheckCookie()
    {
        Status = "Logging in...";
        StateHasChanged();

        // --- Perform login ---
        HttpRequestMessage? request = new HttpRequestMessage(HttpMethod.Post, "api/User/login")
        {
            Content = JsonContent.Create(new { username = "bob", password = "password123" })
        };

        // ✅ Allow cookies in the request
        request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);

        HttpResponseMessage? response = await Http.SendAsync(request);

        if (!response.IsSuccessStatusCode)
        {
            Status = $"Login failed: {response.StatusCode}";
            return;
        }

        Status = "Login successful. Checking browser cookies...";

        // --- Check cookies using Verify ---
        request = new HttpRequestMessage(HttpMethod.Get, "api/User/verify");
        request.SetBrowserRequestCredentials(BrowserRequestCredentials.Include);
        HttpResponseMessage? verifyResponse = await Http.SendAsync(request);

        if (verifyResponse.IsSuccessStatusCode)
        {
            VerifyResult? verifyData = await verifyResponse.Content.ReadFromJsonAsync<VerifyResult>();
            if (verifyData != null)
            {
                Status = $"Authenticated successfully!, username: {verifyData.Username}";
            }
            else
            {
                Status = "Authentication succeeded but no data returned.";
            }
        }
        else
        {
            Status = $"Authentication failed: {verifyResponse.StatusCode}";
        }
    }
    private class VerifyResult
    {
        public bool loggedIn { get; set; }
        public string Username { get; set; } = "";
    }
}
