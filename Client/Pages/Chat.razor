@page "/chat"
@using Client.Services
@using Shared.Models
@using Microsoft.JSInterop

@inject IJSRuntime JS
@inject ChatService ChatService
@inject AuthService AuthService

<h3>Chat</h3>

@if (!isLoggedIn)
{
    <p>Please log in to access chat groups.</p>
}
else
{
    <div class="chat-container">

        <!-- Group selection -->
        <div class="chat-groups">
            <select class="group-select" @bind="SelectedGroupId" @bind:event="onchange">
                @if(Groups.Count == 0)
                {
                    <option disabled>No groups available</option>
                }
                else
                {
                    if (SelectedGroupId == 0)
                    {
                        <option value="0">-- Select Group --</option>
                    }
                    @foreach (var group in Groups)
                    {
                        <option value="@group.Id">@group.Name</option>
                    }
                }

            </select>
        </div>

        <!-- Messages window -->
        <div class="chat-window">
            <div class="messages-container" @ref="messagesContainer">
                @foreach (var msg in Messages)
                {
                    <div class="message @(msg.SenderId == currentUserId ? "mine" : "theirs")">
                        <div class="bubble">
                            @if (msg.SenderId != currentUserId)
                            {
                                <span class="sender">@msg.SenderName</span>
                            }
                            <span>@msg.Content</span>
                            <div class="timestamp">@msg.CreatedAt.ToLocalTime().ToString("HH:mm")</div>
                        </div>
                    </div>
                }
            </div>

            <!-- Input bar pinned at bottom -->
            <div class="input-bar">
                <input type="text" placeholder="Type a message..." @bind="NewMessage" @onkeypress="OnEnterPress" />
                <button class="send-btn" @onclick="SendMessage">Send</button>
            </div>
        </div>

    </div>
}
@code {
    private List<ChatGroupDto> Groups = new();
    private List<MessageDto> Messages = new();

    private int selectedGroupId = 0;
    private string NewMessage = string.Empty;
    private bool isLoggedIn = false;
    private int currentUserId; 

    private ElementReference messagesContainer;

    private int SelectedGroupId
    {
        get => selectedGroupId;
        set
        {
            if (selectedGroupId != value)
            {
                selectedGroupId = value;
                _ = LoadMessagesAsync(selectedGroupId);
            }
        }
    }

    // ----------------- Task Methods -----------------
    protected override async Task OnInitializedAsync()
    {
        UserDto? user = await AuthService.GetCurrentUserAsync();
        if (user != null)
        {
            isLoggedIn = true;
            currentUserId = user.Id;
            Groups = await ChatService.GetGroupsAsync();
        }        
    }

    private async Task LoadMessagesAsync(int groupId)
    {
        if (groupId != 0)
        {
            Messages = await ChatService.GetMessagesAsync(groupId);
            StateHasChanged();

            // Scroll after loading
            await Task.Delay(50);
            await ScrollToBottomAsync();
        }
        else
        {
            Messages.Clear();
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(NewMessage) && SelectedGroupId != 0)
        {
            var sent = await ChatService.SendMessageAsync(SelectedGroupId, NewMessage);
            if (sent != null)
            {
                Messages.Add(sent);
                NewMessage = "";
                StateHasChanged();

                // Scroll after sending
                await Task.Delay(50);
                await ScrollToBottomAsync();
            }
        }
    }
    
    private async Task ScrollToBottomAsync()
    {
        await JS.InvokeVoidAsync("scrollHelper.scrollToEnd", messagesContainer);
    }


    // Handle Enter key press to send message
    private async Task OnEnterPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }
}
