@page "/chat"
@using Shared.Models
@using Client.Services
@inject ChatService ChatService
@inject AuthService AuthService

<h3 class="text-xl font-semibold mb-4">💬 Chat</h3>

@if (!isLoggedIn)
{
    <p>Please log in to access chat groups.</p>
}
else
{
    <div class="chat-container">
        <div class="chat-sidebar">
            <label class="block mb-2 font-semibold">Select Group:</label>
            <select @bind="SelectedGroupId" @bind:event="onchange" class="group-select">
                <option value="0">-- Select --</option>
                @foreach (var group in Groups)
                {
                    <option value="@group.Id">@group.Name</option>
                }
            </select>
        </div>

        <div class="chat-window">
            @if (SelectedGroupId == 0)
            {
                <p class="text-gray-500">Select a group to start chatting.</p>
            }
            else
            {
                <div class="messages-container" @ref="messagesDiv">
                    @foreach (var msg in Messages)
                    {
                        var isMine = msg.SenderId == currentUserId;
                        <div class="message @(isMine ? "mine" : "theirs")">
                            <div class="bubble">
                                @if (!isMine)
                                {
                                    <span class="sender">@msg.SenderName</span>
                                }
                                <span>@msg.Content</span>
                                <div class="timestamp">@msg.CreatedAt.ToLocalTime().ToShortTimeString()</div>
                            </div>
                        </div>
                    }
                </div>

                <div class="input-bar">
                    <input @bind="NewMessage" @bind:event="oninput" placeholder="Type a message..."
                           @onkeydown="HandleKeyPress" />
                    <button class="send-btn" @onclick="SendMessage">Send</button>
                </div>
            }
        </div>
    </div>
}

@code {
    private List<ChatGroupDto>? Groups;
    private List<MessageDto> Messages = new();
    private int selectedGroupId;
    private string NewMessage = "";
    private bool isLoggedIn = false;
    private int currentUserId;
    private ElementReference messagesDiv;

    private int SelectedGroupId
    {
        get => selectedGroupId;
        set
        {
            if (selectedGroupId != value)
            {
                selectedGroupId = value;
                _ = LoadMessagesAsync(selectedGroupId);
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoggedIn = await AuthService.IsLoggedInAsync();
        if (isLoggedIn)
        {
            Groups = await ChatService.GetGroupsAsync();
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser != null)
            {
                currentUserId = currentUser.Id;
            }
        }
    }

    private async Task LoadMessagesAsync(int groupId)
    {
        if (groupId != 0)
        {
            Messages = await ChatService.GetMessagesAsync(groupId);
            await ScrollToBottomAsync();
        }
        else
        {
            Messages.Clear();
        }
        StateHasChanged();
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(NewMessage) && SelectedGroupId != 0)
        {
            var sent = await ChatService.SendMessageAsync(SelectedGroupId, NewMessage);
            Messages.Add(sent);
            NewMessage = "";
            await ScrollToBottomAsync();
        }
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            _ = SendMessage();
    }

    private async Task ScrollToBottomAsync()
    {
        await Task.Delay(50);
        //await messagesDiv.ScrollToEndAsync();
    }

}
